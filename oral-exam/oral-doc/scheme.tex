%%% -*-LaTeX-*-

\chapter{Numerical Schemes}
\label{cha:numerical-schemes}

\section{Deterministic model}
\label{sec:deterministic-model}

The PDE \eqref{eq:nd-master} is a linear advection-reaction equation
for known $\ndRotation$ and $\ndVelocity$, but the whole system including the force
balance equations (i.e. \eqref{eq:nd-master}, \eqref{eq:nd-vel}, and
\eqref{eq:nd-angvel}) is nonlinear. Numerically, I linearized the
system by lagging the angular and linear velocities in order to find
the bond density distribution at the next time step. Then I integrated
over the bond distribution to find the net force and torque generated
by the bonds, and used that to update the angular and linear
velocities. As suggested by the results above, I will need to modify
this approach to handle the case where a platelet is initially firmly
adhered and unmoving, until fluid forces are applied.

I solve the PDE using a first order upwind scheme in both $\recAngle$ and
$\ndWallDist$. These velocities are always non-negative, so I approximate the
spatial derivatives with a forward difference. The bond formation term
is treated explicitly, so that I can advance time with just a matrix
multiplication, instead of solving a linear system. The bond breaking
term essentially \emph{must} be treated implicitly, because the
breaking rate is very large over much of the domain $(\ndWallDist,
\recAngle)$. Luckily it only requires a scalar division for each
element of $\ndBondDensity^k$ to treat that term implicitly.

In summary, for each timestep $k$, I do the following:
\begin{enumerate}
\item Advance the PDE in time using the velocities from the previous
  timestep:
  \begin{multline}
    \label{eq:pde-timestep}
    \ndBondDensity_{i,j}^{k+1} = \frac{1}{1 + \Delta \dTime
      \exp(\offForceScale \ndLength_{ij})} \left(\ndBondDensity_{ij}^k +
      \ndRotation^k \Delta \dTime \left(\frac{\ndBondDensity_{i, j+1}^k -
          \ndBondDensity_{ij}^k}{\nu}\right) + \ndVelocity^k \Delta \dTime
      \left(\frac{\ndBondDensity_{i+1, j}^k -
          \ndBondDensity_{ij}^k}{h}\right)\right. \\ 
    \left. + \kappa \Delta \dTime \exp\left(-\eta
        \frac{\ndLength_{ij}}{2}\right) \left(1 - h \sum_{q = 0}^{N-1}
        \ndBondDensity_{qj}^k\right)\right) 
  \end{multline}
\item Calculate $\ndHorzTotalForce^{k+1}$ and $\ndTotalTorque^{k+1}$ from the new bond
  distribution $\ndBondDensity^{k+1}$.
\item Find the new angular and linear velocities:
  \begin{align}
    \label{eq:ang-timestep}
    \ndRotation^{k+1} &= \ndAppliedRot + \ndTotalTorque^{k+1}/\ndRotFriction \\
    \label{eq:vel-timestep}
    \ndVelocity^{k+1} &= \ndAppliedVel + \ndHorzTotalForce^{k+1}/\ndVelFriction.
  \end{align}
\item Repeat
\end{enumerate}

\section{Stochastic Model}
\label{sec:stochastic-model}

\begin{enumerate}
\item Discretize the interval $[-\pi/2, \pi/2)$ into $N$ equal bins.
\item Initialize list of bonds and angular and linear velocities. 
\item For each time step up to $\dTime_\tn{max}$, \label{item:stoch-iter}
  \begin{enumerate}
  \item Update the $\ndWallDist$ and $\recAngle$ values for every bond. (For the
    variable time step algorithm, this happens after the formation and
    breaking rates are calculated, but before the bond list is updated)
  \item Bin each bond in one of the $N$ $\recAngle$-bins. Any bond for
    which $\recAngle < -\pi/2$ or $\recAngle > \pi/2$ is flagged to be
    removed from the list.
  \item For each $\recAngle$-bin, compute the rate of bond formation
    within that bin from $\onRate(\recAngle_j) (b_\tn{max} - \bondDensity_j)$ where
    $\bondDensity_i$ is the number of existing bonds with endpoints in interval
    $I_j$.
  \item For each existing bond, compute the rate of bond breaking.
  \item Update the bond list:
    \begin{itemize}
    \item If using the fixed time step algorithm, generate a random
      number for each existing bond to decide which ones break, and
      randomly sample from N Poisson distributions with $\lambda = dt
      \onRate(\recAngle_j) (b_\tn{max} - \bondDensity_j)$, $j = 1, \hdots, N$ to
      decide how many bonds form in each interval.
    \item If using the variable time step algorithm, generate a random
      number to decide when the first reaction (a bond breaking or
      forming) occurs, and generate a second random number to decide
      which reaction occurs.
    \end{itemize}
  \item Calculate the forces and torques generated by the existing
    bonds, and solve the force balance equations to calculate the new
    $(\ndVelocity, \ndRotation)$ pair.
  \item Return to step \ref{item:stoch-iter}.
  \end{enumerate}
\end{enumerate}
